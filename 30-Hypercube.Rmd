# Hypercube {#c24_hypercube}

```{r}
library(knitr)
library(dplyr)
library(quanteda)
library(data.table)
library(tidytext)
library(FactoMineR)
library(Factoshiny)
library(explor)
```

## Objectives

We have created a list of tags relate to world regions for news published in 14 newspapers. We propose now to build an hypercube in order to explore the results.



## Prepare data

### Load corpus

```{r}
qd<-readRDS("quanteda/corpus_worldgeo_001.RDS")

```

### Load hypercube function
```{r}


hypercube <-function(qd = qd,
                     when = "date",
                     when_cut = "year",
                     who = "source",
                     where1 = "tags",
                     where2 = "tags")
                     
  {   

# create data.table accroding to parameter chosen
  don<-docvars(qd)

  df<-data.table(id = docid(qd),
                 who = don[,who],
                 when = as.character(cut(don[,when],breaks=when_cut)),
                 where1 = don[,where1],
                 where2 = don[,where2])



# add code _no_ for empty fields
df$where1[df$where1==""]<-"_no_"
df$where2[df$where2==""]<-"_no_"


# unnest where1
  df<-unnest_tokens(df,where1,where1,to_lower=F)
  
# unnest where2
  df<-unnest_tokens(df,where2,where2,to_lower=F)  
  
# define number of occurence by id
  nb<-df[,.N,list(id)] %>%  mutate(wgt = 1/N) %>% select(-N)
  df<-df %>% left_join(nb) 
  
  rm(nb)
 
# Aggregate
  hc<- df[,.( tags = .N, news=sum(wgt)) ,.(who, when,where1,where2)]
  
# Convert date to time
  hc$when<-as.Date(hc$when)
  
# return hypercube
  return(hc)

}


```


### Create Hypercube
```{r}

hc_reg <- hypercube(qd = qd,
                     when = "date",
                     when_cut = "months",
                     who = "source",
                     where1 = "tags",
                     where2 = "tags")

kable(head(hc_reg))

```
### Load Wikidata entity names

```{r}
reg_def<-readRDS("dict/worldgeo_def_V1.RDS")

# Choose language
tab_def<-reg_def %>% filter(lang == "en")
kable(head(tab_def))
```


## Geographical entities

### Which % of news ?

What is the percentage of news where at less one geographical entity is mentioned ?

```{r}
hc_reg$tagged<-hc_reg$where1!="_no_"

df<-hc_reg[,list(nb = sum(news)), list(who, tagged)] %>% 
     dcast(formula =  who~tagged, value.var = "nb") 
names(df)<-c("media","No", "Yes")
df$Tot = df$No+df$Yes
df$Pct = 100*df$Yes/df$Tot
df<-df[order(df$Pct)]
kable(df, digits=2)
```

 

### Which entities are the most mentionned ?

Iw we put together all newspapers, we obtain the following table

```{r}

# Compute
df<-hc_reg[where1 !="_no_",list(nb = sum(news)), list(where1)] 
# df<-as.data.frame(df)
df<-merge(tab_def,df,by.x="code",by.y="where1",all.x=F,all.y=T)
df<-df[order(df$nb, decreasing = T),]
row.names(df)<-1:dim(df)[1]

kable(df, digits=0,row.names = T)
```



### Top non state entities by media


```{r}

# Compute
df<-hc_reg[where1 !="_no_",list(nb = sum(news)), list(where1, who)] %>% 
     group_by(who) %>%
     filter((substr(where1,1,2) %in% c("CA","ST"))==FALSE)  %>%
     mutate(pct = 100*nb/sum(nb),
            rnk = rank(-nb))

df<-merge(tab_def,df,by.x="code",by.y="where1",all.x=F,all.y=T)

res <- df %>% filter(rnk < 11) %>% select(who, rnk,label, pct) %>% mutate(who=substr(who,4,12))
res<-res[order(res$who, res$rnk),]

  
kable(res,digits=c(0,1))

```


